df <- data.frame(population_2018 = c(366461,	347785,	371843,	366491,	371614,		376257,	369355,	362390,	357568,	352721,		340459,	322227,	331739,	322268,	303107,		290064,	281714,	283146,	236524,	217128,		188624,	163682,	130361,	115094,	131793,		130980,	125531,	122657,	118131,	108186,		96615,	90310,	80748,	75140,	67241,		59830,	54914,	50412,	44683,	37895,		31566,	25500,	20867,	15731,	11102,		8175,	6357,	4587,	2890,	1839),
                 population_2019 = c(366966,	365147,	346620,	370467,	364946,		370010,	374547,	367434,	360320,	355274,		350537,	338221,	320007,	329071,	319683,		300439,	287331,	278617,	279717,	233413,		213814,	185485,	160781,	127696,	112390,		128446,	127340,	121744,	118470,	113634,		103638,	92010,	85271,	75821,	69875,		62062,	54631,	49578,	45075,	39318,		32734,  26953,	21401,	17312,	12699,		8790,	6384,	4913,	3420,	2119),
                 population_2020 = c(365204,	365171,	363228,	344723,	368317,		362854,	367622,	372057,	364789,	357510,		352304,	347427,	335052,	316838,	325464,		315908,	296709,	283456,	274583,	275183,		229401,	209764,	181576,	157138,	124470,		109223,	124620,	123333,	117476,	113841,		108725,	98729,	87027,	80212,	70730,		64652,	56798,	49562,	44468,	39948,		34106,	28165,	22853,	17882,	14098,	 10196,	6934,	4979,	3759,	2569),
                 death_2018 = c(1315,	1444,	1607,	1765,	1846,	1969,	2068,	2131,	2345,	2472,	2390,	2561,	2734,	2818,	2922,	2938,	3132,	3213,	3034,	3110,	2932,	2629,	2409,	2836,	3312,	3577,	3747,	4152,	4372,	4454,	4714,	4794,	4846,	5035,	5088,	5102,	5257,	5610,	5279,	4894,	4447,	3967,	3464,	2831,	2288,	1873,	1562,	1128,	800,	502), 
                 death_2019 = c(1367,	1500,	1496,	1695,	1856,	1845,	2111,	2220,	2372,	2474,	2521,	2484,	2667,	2929,	3097,	3007,	3106,	3437,	3369,	3221,	3378,	2939,	2893,	2451,	3092,	3504,	3635,	3921,	4268,	4501,	4520,	4767,	4994,	4964,	5259,	5105,	5221,	5341,	5194,	5315,	4839,	4194,	3713,	3227,	2603,	2011,	1555,	1240,	931,	563), 
                 death_2020 = c(1326,	1475,	1517,	1664,	1766,	1785,	2056,	2129,	2221,	2358,	2512,	2621,	2611,	2774,	3063,	3177,	3083,	3189,	3457,	3444,	3245,	3330,	3114,	2873,	2583,	3169,	3553,	3743,	4133,	4561,	4672,	4769,	4861,	4950,	4981,	5188,	4975,	5056,	5017,	5103,	4795,	4170,	3750,	3338,	2712,	2161,	1565,	1204,	985,	636))

df$death_rate <- (df$death_2018 + df$death_2019 + df$death_2020) / (df$population_2018 + df$population_2019 + df$population_2020)
df$population <- (df$population_2018 + df$population_2019 + df$population_2020)
df$death <- (df$death_2018 + df$death_2019 + df$death_2020)

### WLS

sum = 0
f = function(x) {
  for (i in 6:50) {
    sum = sum + as.numeric(df[i, 8])*(log(-log(1 - as.numeric(df[i, 7]))) - x[1] - x[2]*(49 + i))^2
  }
  sum
}
f = function(x) {
  for (i in 6:50) {
    sum = sum + sqrt(as.numeric(df[i, 8]))*(log(-log(1 - as.numeric(df[i, 7]))) - x[1] - x[2]*(49 + i))^2
  }
  sum
}
f = function(x) {
  for (i in 6:50) {
    sum = sum + log(as.numeric(df[i, 8]))*(log(-log(1 - as.numeric(df[i, 7]))) - x[1] - x[2]*(49 + i))^2
  }
  sum
}
f = function(x) {
  for (i in 6:50) {
    sum = sum + (log(-log(1 - as.numeric(df[i, 7]))) - x[1] - x[2]*(49 + i))^2
  }
  sum
}
wls_1 = nlminb(start = c(0, 0), f)
C_wls_1 = exp(wls_1$par[2])
B_wls_1 = exp(wls_1$par[1] + log(C_wls_1 - 1) - log(log(C_wls_1)))

### NM

sum = 0
f = function(x) {
  for (i in c(1:50)) {
    sum = sum + (as.numeric(df[i, 8]))*((1 - as.numeric(df[i, 7])) - exp(-x[1]*(x[2]^(49 + i))*(x[2] - 1)/log(x[2])))^2
  }
  sum
}
f = function(x) {
  for (i in c(1:50)) {
    sum = sum + (sqrt(as.numeric(df[i, 8])))*((1 - as.numeric(df[i, 7])) - exp(-x[1]*(x[2]^(49 + i))*(x[2] - 1)/log(x[2])))^2
  }
  sum
}
f = function(x) {
  for (i in c(1:50)) {
    sum = sum + ((1 - as.numeric(df[i, 7])) - exp(-x[1]*(x[2]^(49 + i))*(x[2] - 1)/log(x[2])))^2
  }
  sum
}
nm_1 = nlminb(start = c(0.01, 1.01), f)
### MLE
sum = 0
f = function(x) {
  for (i in c(1:50)) {
    sum = sum + ((as.numeric(df[i, 8]) - as.numeric(df[i, 9]))*x[1]*(x[2]^(49 + i))*(x[2] - 1)/log(x[2]) - as.numeric(df[i, 9])*log(1 - exp(-x[1]*(x[2]^(49 + i))*(x[2] - 1)/log(x[2]))))^2
  }
  sum
}
mle_1 = nlminb(start = c(0.00001, 1.1), f)

### MSE誤差
results <- c()
  for (i in 6:50) {
    ans = 1 - exp(-1.574603e-05*(1.106692^(49+i))*(1.106692-1)/log(1.106692))
    results <- c(results, ans)
  }

sum = 0
for (i in 6:50) {
  sum = sum + ((results[i-5] - df[i, 7])^2) / 50
}
sum = sqrt(sum)
sum = 0
for (i in 6:50) {
  sum = sum + abs((results[i-5] - df[i, 7])) / 50
}

sum
B_wls_1
C_wls_1
